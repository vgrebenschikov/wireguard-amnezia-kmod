hp() {
	local max32bit=4294967295
	local h=$(jot -r 1 5 $max32bit)
	local d=$(jot -r 1 0 65365)
	hm=$((h + d))
	if [ $hm -gt $max32bit ]; then
		hm=$max32bit
	fi
	echo "$h-$hm"
}

check_h_overlap()
{
	h=$1
	ha=${h%%-*}
	hb=${h#*-}
	shift
	for i in "$@"; do
		ia=${i%%-*}
		ib=${i#*-}

		if [ $hb -ge $ia ] && [ $ib -ge $ha ]; then
			return 1
		fi
	done
	return 0
}

# Actual confiruration parameters for AWG (AWG2)
awg_config() {
	for i in 1 2 3 4; do
		jc=$(jot -r 1 3 10)
		jmin=$(jot -r 1 50 100)
		jmax=$(jot -r 1 $jmin 1000)

		s1=$(jot -r 1 15 1132)
		s2=$(jot -r 1 15 1188)
		s3=$(jot -r 1 15 800)
		s4=$(jot -r 1 15 100)

		h1=$(hp)
		h2=$(hp)
		h3=$(hp)
		h4=$(hp)

		# check overlaps
		check_h_overlap $h1 $h2 $h3 $h4 || continue
		check_h_overlap $h2 $h1 $h3 $h4 || continue
		check_h_overlap $h3 $h1 $h2 $h4 || continue
		check_h_overlap $h4 $h1 $h2 $h3 || continue

		break
	done

	# i1="<b 0xdeadbeef><c><b 0xdeadbeef><t><r 10><rd 8><c><rc 16>"

	cfg="jc $jc jmin $jmin jmax $jmax
		s1 $s1 s2 $s2 s3 $s3 s4 $s4
		h1 $h1 h2 $h2 h3 $h3 h4 $h4"

	echo $cfg
	echo "AWG:" $cfg 1>&2
}

awg_config_get() {
	key="$1"
	shift
	echo "$*" | awk -v k="$key" '{for(i=1;i<NF;i+=2) if($i==k){print $(i+1); exit}}'
}

agw_long_i() {
	echo "<b 0xcb0000000114e578be7dbe5a60578fc0102e8c6657a100881b9b149e0453b28365f27f4ae3e6cfe95a49569d4a06d7008000047c9ebb914b01167be0c201b86f2de6f6f8177d13fbfc7f0b0fa5ee4074b6da600bb1e6c203f958065abfca193207dc5abf246a7a47f243c25bf4d39c8610f199f6ca5dede6a28096352a58ead72b8b149f4542e6b8dbbbcfebf9e57064a256a01640a615703ac98830fc09949a3a49b333fda507269d57e13b97ad34d62c1e99768d85785cf4d1da43c26e65d4ef8edf36c9012bb2190f208bfea53ecc63eb7c428e9fe9b8992f5d46f92d5ed79707dc04700615725ffa039f4d6f9dc43e19de986bab85f953e48292f8a65608e0374602705c2eae5211ba425927af64c97ce6d800a169b2bbf34b94eb9173574e1ff668d8ef7c1d8cc723476109b66aea71859c0bbb1e17bf15f807d6a703dfdc7dc22ab8caf75043164ed896e755399360e1a8fdd11a7eddc8aad6a6a40620621b3147317c61eda39f6afe1b4ce12b453c027c2bb9c0d856319550fb4f26349ee102d7460d15253c6b9b7a15fc5b997264925bccd7a8ed5526da7fa54b366e74c51b6355e5a9e4d40227967193c2856c06b072f19831e99ff9e72f774151afc91ebc1a70c0b5cb84bd7653ca26206d2a482a3f46088d4eee3a48df2b323daa3969c321c6c97ce4c96a1afcc0ed32fa6f69247cbaae28d878c21f950f44bc466ba756ca64b0bdd0473cfca97f6e2b6d6598c0173f98fccc66a5b11a4f877f7822e233de40418c2b72dc98b622d47d6b88e56b8ff1021e0d42c0a863b6dece073121bfc4f865ea2a08ac6621895b05ace9e8cdfbc93681a9d0c06c9a403e5bfcbaa70992197af2de54d89ea330c407b93f4778273c20be0531ebc2855da8dd291291c47ff3c212d0d04b2b3717c5ba77bf54c07e266db3e0e43844eca14692a74d1f6eb1ea1b3f801038647a944900f09d8cebfe152c33b30bb136133566904e7d540d016a3bfa2e99189961a3a16a67fcb739fa139fffc2abd9856509e44edfe538074d59bfb3909b68db526d23e846b23d5e265f23b7cfe162ec7c847fbb481020de42ebec9fdfa5e7b7241d546c1855c5668d73998cfd891035c3dceb94a8323c12db508641ee2265ced50d82fd894e63ce6d8b34fddddb271d88c2f4398b35e9ae468675a3a20bb120518ee101330d61644cf3e0683a208e4d44bd89b8c83d2141498802b085fd6e9c37d41fdeee4c4844199951e5dc0ecfc913afa187fbc86ecbc21ee722d4bc640e0f0022604d19d41d7c4cdadeec26fced07a92c59b89bc2c73e48b863221e6a73cfb03f852c558e10ed964944321f8b69b211ad0bd96721853661f9a8485bb3894d1709a22d28e2ad871dabaef11d7866e1d9e7f83d488772847856bdee895253efa842bf000a801585ac8d0bbeccf82b185be316a815841a1425446fab34edca6a45d7489e82f5468a0d7c3c2f0e7f947d782051d8980717d34451470fb0cb6254d5d7d2f45ff59d882a17da735419d330812fbcc111dd3966e9bb74e603e0c587aacf857951936b06908cd0080a638f607e93dfee5ddc097d2be0762877164120f8c0ab28d1cb7f75c854856c1362b2126c8f787e1c0b0676c1b0dc5b7d8f92fa05297e30cd93a2e4174b29dc8dd5db45a23e1935a1f044a2ff8771a395f705986ecc8039>"
}

# Compatibility confiruration parameters for AWG (AWG1)
awg1_config() {
	for i in 1 2 3 4; do
		jc=$(jot -r 1 3 10)
		jmin=$(jot -r 1 50 100)
		jmax=$(jot -r 1 $jmin 1000)

		s1=$(jot -r 1 15 1132)
		s2=$(jot -r 1 15 1188)

		h1=$(jot -r 1 5 4294967295)
		h2=$(jot -r 1 5 4294967295)
		h3=$(jot -r 1 5 4294967295)
		h4=$(jot -r 1 5 4294967295)

		if [ $(($s1 + 56)) -ne $s2 ] && \
		   [ $(echo -e "$h1\n$h2\n$h3\n$h4" | sort -u | wc -l) -eq 4 ]; then
			break
		fi
	done

	echo \
		jc $jc jmin $jmin jmax $jmax \
		s1 $s1 s2 $s2 \
		h1 $h1 h2 $h2 h3 $h3 h4 $h4
}

setup_vnet_jails() {
	local endpoint1=$1 endpoint2=$2
	local epair1 epair2

	kldload -n if_wg || atf_skip "This test requires if_wg and could not load it"
	kldload -n if_bridge || atf_skip "This test requires if_bridge and could not load it"

	jail -r wgtest1 2> /dev/null || true
	jail -r wgtest2 2> /dev/null || true

	epair1=$(vnet_mkepair)
	epair2=$(vnet_mkepair)

	vnet_init

	vnet_mkjail wgtest1 ${epair1}b
	vnet_mkjail wgtest2 ${epair2}b

	ifconfig wgbr0 > /dev/null 2>&1 || ifconfig bridge create name wgbr0
	for i in $(ifconfig wgbr0 | awk '/member:/ {print $2}'); do
		ifconfig wgbr0 deletem $i
	done
	ifconfig wgbr0 up

	jexec wgtest1 ifconfig ${epair1}b ${endpoint1}/24 up
	jexec wgtest2 ifconfig ${epair2}b ${endpoint2}/24 up

	ifconfig ${epair1}a up
	ifconfig ${epair2}a up
	ifconfig wgbr0 addm ${epair1}a addm ${epair2}a
}

setup_debug() {
	case "$DEBUG" in
		yes|true|1)
			exec > `tty` 2>&1
			set -x
			;;
	esac
}
